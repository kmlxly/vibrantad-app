-- BAIKI HUBUNGAN JADUAL (REPAIR TABLE RELATIONSHIP)
-- Sila jalankan kod ini di SQL Editor Supabase anda

-- 1. Padam jadual lama jika wujud (untuk pastikan struktur bersih)
-- AMARAN: Ini akan memadam data dalam working_requests jika ada.
DROP TABLE IF EXISTS working_requests;

-- 2. Cipta semula jadual dengan hubungan (Foreign Key) yang betul
CREATE TABLE working_requests (
  id bigint generated by default as identity primary key,
  user_id uuid NOT NULL,
  type text check (type in ('WFH', 'Remote', 'Lapangan')) not null,
  start_date date not null,
  end_date date not null,
  reason text not null,
  status text check (status in ('pending', 'approved', 'rejected')) default 'pending' not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- Hubungan Rasmi ke jadual profiles
  CONSTRAINT fk_working_requests_profiles 
    FOREIGN KEY (user_id) 
    REFERENCES profiles(id) 
    ON DELETE CASCADE
);

-- 3. Enable RLS
ALTER TABLE working_requests ENABLE ROW LEVEL SECURITY;

-- 4. Policies
CREATE POLICY "Allow all to view working_requests" ON working_requests FOR SELECT USING (true);
CREATE POLICY "Allow staff to insert their own requests" ON working_requests FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Allow admin to update status" ON working_requests FOR UPDATE USING (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE profiles.id = auth.uid() 
    AND (LOWER(profiles.role) = 'admin')
  )
);

-- 5. Paksa reload schema cache
NOTIFY pgrst, 'reload config';
